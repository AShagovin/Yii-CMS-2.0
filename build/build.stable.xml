<?xml version="1.0" encoding="UTF-8"?>
<project name="yii-cms" basedir="." default="build">

    <import file="lib/variables.dev.xml" />
    <tstamp />
    <!-- Sets the DSTAMP, TSTAMP and TODAY properties -->

    <target name="clear.cache">
        <echo>Очищаем директории кэша</echo>
        <delete dir="${webroot}/assets/" />
        <mkdir dir="${webroot}/assets/" mode="0777" />
        <delete dir="${app.dir}/runtime/" />
        <mkdir dir="${app.dir}/runtime/" mode="0777" />
    </target>

    <target name="repo.create_tag">
        <exec command="git checkout origin master" passthru="true" checkreturn="true"/>
        <exec command="git commit -am 'Stable Version: ${version.cms}'" passthru="true" checkreturn="true"/>
        <exec command="git tag -a ${version.cms} -m 'Version: ${version.cms}'" />
        <exec command="git push origin master --tags" />
    </target>


    <target name="db.migrate">
        <exec command="${php.local.bin} ${yiic} migrate" />
    </target>

    <target name="doc.generate">
        <delete dir="./doc/" />
        <mkdir dir="./doc/" mode="0777" />
        <phpdoc2 title="API Documentation" destdir="./doc" template="responsive">
            <fileset dir="${app.dir}" includes="**/*.php" excludes="${doc.excludes}" />
        </phpdoc2>
    </target>

    <target name="build.set_version">
        <reflexive>
            <fileset dir="${build.dir}" includes="${build.set_version.includes}" excludes="${build.set_version.excludes}" />
            <filterchain>
                <replaceregexp>
                    <regexp pattern="@version \$(Id)\$" replace="@version ${build.version}" />
                </replaceregexp>
            </filterchain>
        </reflexive>
    </target>


    <target name="build" depends="clear.cache, db.migrate, doc.generate">
        <echo msg="All done." />
    </target>

</project>
